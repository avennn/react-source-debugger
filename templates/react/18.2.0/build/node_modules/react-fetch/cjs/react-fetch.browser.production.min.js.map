{"version":3,"file":"react-fetch.browser.production.min.js","sources":["../../../../packages/react-fetch/src/ReactFetchBrowser.js"],"sourcesContent":["/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Wakeable} from 'shared/ReactTypes';\n\nimport {unstable_getCacheForType} from 'react';\n\nconst Pending = 0;\nconst Resolved = 1;\nconst Rejected = 2;\n\ntype PendingRecord = {|\n  status: 0,\n  value: Wakeable,\n|};\n\ntype ResolvedRecord = {|\n  status: 1,\n  value: mixed,\n|};\n\ntype RejectedRecord = {|\n  status: 2,\n  value: mixed,\n|};\n\ntype Record = PendingRecord | ResolvedRecord | RejectedRecord;\n\ndeclare var globalThis: any;\n\n// TODO: this is a browser-only version. Add a separate Node entry point.\nconst nativeFetch = (typeof globalThis !== 'undefined' ? globalThis : window)\n  .fetch;\n\nfunction getRecordMap(): Map<string, Record> {\n  return unstable_getCacheForType(createRecordMap);\n}\n\nfunction createRecordMap(): Map<string, Record> {\n  return new Map();\n}\n\nfunction createRecordFromThenable(thenable): Record {\n  const record: Record = {\n    status: Pending,\n    value: thenable,\n  };\n  thenable.then(\n    value => {\n      if (record.status === Pending) {\n        const resolvedRecord = ((record: any): ResolvedRecord);\n        resolvedRecord.status = Resolved;\n        resolvedRecord.value = value;\n      }\n    },\n    err => {\n      if (record.status === Pending) {\n        const rejectedRecord = ((record: any): RejectedRecord);\n        rejectedRecord.status = Rejected;\n        rejectedRecord.value = err;\n      }\n    },\n  );\n  return record;\n}\n\nfunction readRecordValue(record: Record) {\n  if (record.status === Resolved) {\n    return record.value;\n  } else {\n    throw record.value;\n  }\n}\n\nfunction Response(nativeResponse) {\n  this.headers = nativeResponse.headers;\n  this.ok = nativeResponse.ok;\n  this.redirected = nativeResponse.redirected;\n  this.status = nativeResponse.status;\n  this.statusText = nativeResponse.statusText;\n  this.type = nativeResponse.type;\n  this.url = nativeResponse.url;\n\n  this._response = nativeResponse;\n  this._arrayBuffer = null;\n  this._blob = null;\n  this._json = null;\n  this._text = null;\n}\n\nResponse.prototype = {\n  constructor: Response,\n  arrayBuffer() {\n    return readRecordValue(\n      this._arrayBuffer ||\n        (this._arrayBuffer = createRecordFromThenable(\n          this._response.arrayBuffer(),\n        )),\n    );\n  },\n  blob() {\n    return readRecordValue(\n      this._blob ||\n        (this._blob = createRecordFromThenable(this._response.blob())),\n    );\n  },\n  json() {\n    return readRecordValue(\n      this._json ||\n        (this._json = createRecordFromThenable(this._response.json())),\n    );\n  },\n  text() {\n    return readRecordValue(\n      this._text ||\n        (this._text = createRecordFromThenable(this._response.text())),\n    );\n  },\n};\n\nfunction preloadRecord(url: string, options: mixed): Record {\n  const map = getRecordMap();\n  let record = map.get(url);\n  if (!record) {\n    if (options) {\n      if (options.method || options.body || options.signal) {\n        // TODO: wire up our own cancellation mechanism.\n        // TODO: figure out what to do with POST.\n        // eslint-disable-next-line react-internal/prod-error-codes\n        throw Error('Unsupported option');\n      }\n    }\n    const thenable = nativeFetch(url, options);\n    record = createRecordFromThenable(thenable);\n    map.set(url, record);\n  }\n  return record;\n}\n\nexport function preload(url: string, options: mixed): void {\n  preloadRecord(url, options);\n  // Don't return anything.\n}\n\nexport function fetch(url: string, options: mixed): Object {\n  const record = preloadRecord(url, options);\n  const nativeResponse = (readRecordValue(record): any);\n  if (nativeResponse._reactResponse) {\n    return nativeResponse._reactResponse;\n  } else {\n    return (nativeResponse._reactResponse = new Response(nativeResponse));\n  }\n}\n"],"names":["Pending","Resolved","Rejected","nativeFetch","globalThis","window","fetch","getRecordMap","unstable_getCacheForType","createRecordMap","Map","createRecordFromThenable","thenable","record","status","value","then","resolvedRecord","err","rejectedRecord","readRecordValue","Response","nativeResponse","headers","ok","redirected","statusText","type","url","_response","_arrayBuffer","_blob","_json","_text","prototype","constructor","arrayBuffer","blob","json","text","preloadRecord","options","map","get","method","body","signal","Error","set","preload","_reactResponse"],"mappings":";;;;AAaA,MAAMA,OAAO,GAAG,CAAhB;AACA,MAAMC,QAAQ,GAAG,CAAjB;AACA,MAAMC,QAAQ,GAAG,CAAjB;AAqBA;AACA,MAAMC,WAAW,GAAG,CAAC,OAAOC,UAAP,KAAsB,WAAtB,GAAoCA,UAApC,GAAiDC,MAAlD,EACjBC,KADH;;AAGA,SAASC,YAAT,GAA6C;AAC3C,SAAOC,8BAAwB,CAACC,eAAD,CAA/B;AACD;;AAED,SAASA,eAAT,GAAgD;AAC9C,SAAO,IAAIC,GAAJ,EAAP;AACD;;AAED,SAASC,wBAAT,CAAkCC,QAAlC,EAAoD;AAClD,QAAMC,MAAc,GAAG;AACrBC,IAAAA,MAAM,EAAEd,OADa;AAErBe,IAAAA,KAAK,EAAEH;AAFc,GAAvB;AAIAA,EAAAA,QAAQ,CAACI,IAAT,CACED,KAAK,IAAI;AACP,QAAIF,MAAM,CAACC,MAAP,KAAkBd,OAAtB,EAA+B;AAC7B,YAAMiB,cAAc,GAAKJ,MAAzB;AACAI,MAAAA,cAAc,CAACH,MAAf,GAAwBb,QAAxB;AACAgB,MAAAA,cAAc,CAACF,KAAf,GAAuBA,KAAvB;AACD;AACF,GAPH,EAQEG,GAAG,IAAI;AACL,QAAIL,MAAM,CAACC,MAAP,KAAkBd,OAAtB,EAA+B;AAC7B,YAAMmB,cAAc,GAAKN,MAAzB;AACAM,MAAAA,cAAc,CAACL,MAAf,GAAwBZ,QAAxB;AACAiB,MAAAA,cAAc,CAACJ,KAAf,GAAuBG,GAAvB;AACD;AACF,GAdH;AAgBA,SAAOL,MAAP;AACD;;AAED,SAASO,eAAT,CAAyBP,MAAzB,EAAyC;AACvC,MAAIA,MAAM,CAACC,MAAP,KAAkBb,QAAtB,EAAgC;AAC9B,WAAOY,MAAM,CAACE,KAAd;AACD,GAFD,MAEO;AACL,UAAMF,MAAM,CAACE,KAAb;AACD;AACF;;AAED,SAASM,QAAT,CAAkBC,cAAlB,EAAkC;AAChC,OAAKC,OAAL,GAAeD,cAAc,CAACC,OAA9B;AACA,OAAKC,EAAL,GAAUF,cAAc,CAACE,EAAzB;AACA,OAAKC,UAAL,GAAkBH,cAAc,CAACG,UAAjC;AACA,OAAKX,MAAL,GAAcQ,cAAc,CAACR,MAA7B;AACA,OAAKY,UAAL,GAAkBJ,cAAc,CAACI,UAAjC;AACA,OAAKC,IAAL,GAAYL,cAAc,CAACK,IAA3B;AACA,OAAKC,GAAL,GAAWN,cAAc,CAACM,GAA1B;AAEA,OAAKC,SAAL,GAAiBP,cAAjB;AACA,OAAKQ,YAAL,GAAoB,IAApB;AACA,OAAKC,KAAL,GAAa,IAAb;AACA,OAAKC,KAAL,GAAa,IAAb;AACA,OAAKC,KAAL,GAAa,IAAb;AACD;;AAEDZ,QAAQ,CAACa,SAAT,GAAqB;AACnBC,EAAAA,WAAW,EAAEd,QADM;;AAEnBe,EAAAA,WAAW,GAAG;AACZ,WAAOhB,eAAe,CACpB,KAAKU,YAAL,KACG,KAAKA,YAAL,GAAoBnB,wBAAwB,CAC3C,KAAKkB,SAAL,CAAeO,WAAf,EAD2C,CAD/C,CADoB,CAAtB;AAMD,GATkB;;AAUnBC,EAAAA,IAAI,GAAG;AACL,WAAOjB,eAAe,CACpB,KAAKW,KAAL,KACG,KAAKA,KAAL,GAAapB,wBAAwB,CAAC,KAAKkB,SAAL,CAAeQ,IAAf,EAAD,CADxC,CADoB,CAAtB;AAID,GAfkB;;AAgBnBC,EAAAA,IAAI,GAAG;AACL,WAAOlB,eAAe,CACpB,KAAKY,KAAL,KACG,KAAKA,KAAL,GAAarB,wBAAwB,CAAC,KAAKkB,SAAL,CAAeS,IAAf,EAAD,CADxC,CADoB,CAAtB;AAID,GArBkB;;AAsBnBC,EAAAA,IAAI,GAAG;AACL,WAAOnB,eAAe,CACpB,KAAKa,KAAL,KACG,KAAKA,KAAL,GAAatB,wBAAwB,CAAC,KAAKkB,SAAL,CAAeU,IAAf,EAAD,CADxC,CADoB,CAAtB;AAID;;AA3BkB,CAArB;;AA8BA,SAASC,aAAT,CAAuBZ,GAAvB,EAAoCa,OAApC,EAA4D;AAC1D,QAAMC,GAAG,GAAGnC,YAAY,EAAxB;AACA,MAAIM,MAAM,GAAG6B,GAAG,CAACC,GAAJ,CAAQf,GAAR,CAAb;;AACA,MAAI,CAACf,MAAL,EAAa;AACX,QAAI4B,OAAJ,EAAa;AACX,UAAIA,OAAO,CAACG,MAAR,IAAkBH,OAAO,CAACI,IAA1B,IAAkCJ,OAAO,CAACK,MAA9C,EAAsD;AACpD;AACA;AACA;AACA,cAAMC,KAAK,CAAC,oBAAD,CAAX;AACD;AACF;;AACD,UAAMnC,QAAQ,GAAGT,WAAW,CAACyB,GAAD,EAAMa,OAAN,CAA5B;AACA5B,IAAAA,MAAM,GAAGF,wBAAwB,CAACC,QAAD,CAAjC;AACA8B,IAAAA,GAAG,CAACM,GAAJ,CAAQpB,GAAR,EAAaf,MAAb;AACD;;AACD,SAAOA,MAAP;AACD;;AAEM,SAASoC,OAAT,CAAiBrB,GAAjB,EAA8Ba,OAA9B,EAAoD;AACzDD,EAAAA,aAAa,CAACZ,GAAD,EAAMa,OAAN,CAAb,CADyD;AAG1D;AAEM,SAASnC,KAAT,CAAesB,GAAf,EAA4Ba,OAA5B,EAAoD;AACzD,QAAM5B,MAAM,GAAG2B,aAAa,CAACZ,GAAD,EAAMa,OAAN,CAA5B;AACA,QAAMnB,cAAc,GAAIF,eAAe,CAACP,MAAD,CAAvC;;AACA,MAAIS,cAAc,CAAC4B,cAAnB,EAAmC;AACjC,WAAO5B,cAAc,CAAC4B,cAAtB;AACD,GAFD,MAEO;AACL,WAAQ5B,cAAc,CAAC4B,cAAf,GAAgC,IAAI7B,QAAJ,CAAaC,cAAb,CAAxC;AACD;AACF;;;;;"}
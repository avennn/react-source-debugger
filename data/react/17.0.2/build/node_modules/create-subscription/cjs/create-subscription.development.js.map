{"version":3,"file":"create-subscription.development.js","sources":["../../../../packages/shared/ReactSharedInternals.js","../../../../packages/shared/consoleWithStackDev.js","../../../../packages/create-subscription/src/createSubscription.js"],"sourcesContent":["/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport * as React from 'react';\n\nconst ReactSharedInternals =\n  React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;\n\nexport default ReactSharedInternals;\n","/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport ReactSharedInternals from 'shared/ReactSharedInternals';\n\n// In DEV, calls to console.warn and console.error get replaced\n// by calls to these methods by a Babel plugin.\n//\n// In PROD (or in packages without access to React internals),\n// they are left as they are instead.\n\nexport function warn(format, ...args) {\n  if (__DEV__) {\n    printWarning('warn', format, args);\n  }\n}\n\nexport function error(format, ...args) {\n  if (__DEV__) {\n    printWarning('error', format, args);\n  }\n}\n\nfunction printWarning(level, format, args) {\n  // When changing this logic, you might want to also\n  // update consoleWithStackDev.www.js as well.\n  if (__DEV__) {\n    const ReactDebugCurrentFrame = ReactSharedInternals.ReactDebugCurrentFrame;\n    const stack = ReactDebugCurrentFrame.getStackAddendum();\n    if (stack !== '') {\n      format += '%s';\n      args = args.concat([stack]);\n    }\n\n    const argsWithFormat = args.map(item => '' + item);\n    // Careful: RN currently depends on this prefix\n    argsWithFormat.unshift('Warning: ' + format);\n    // We intentionally don't use spread (or .apply) directly because it\n    // breaks IE9: https://github.com/facebook/react/issues/13610\n    // eslint-disable-next-line react-internal/no-production-logging\n    Function.prototype.apply.call(console[level], console, argsWithFormat);\n  }\n}\n","/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport * as React from 'react';\nimport invariant from 'shared/invariant';\n\ntype Unsubscribe = () => void;\n\nexport function createSubscription<Property, Value>(\n  config: $ReadOnly<{|\n    // Synchronously gets the value for the subscribed property.\n    // Return undefined if the subscribable value is undefined,\n    // Or does not support synchronous reading (e.g. native Promise).\n    getCurrentValue: (source: Property) => Value | void,\n\n    // Setup a subscription for the subscribable value in props, and return an unsubscribe function.\n    // Return empty function if the property cannot be unsubscribed from (e.g. native Promises).\n    // Due to the variety of change event types, subscribers should provide their own handlers.\n    // Those handlers should not attempt to update state though;\n    // They should call the callback() instead when a subscription changes.\n    subscribe: (\n      source: Property,\n      callback: (value: Value | void) => void,\n    ) => Unsubscribe,\n  |}>,\n): React$ComponentType<{|\n  children: (value: Value | void) => React$Node,\n  source: Property,\n|}> {\n  const {getCurrentValue, subscribe} = config;\n\n  if (__DEV__) {\n    if (typeof getCurrentValue !== 'function') {\n      console.error('Subscription must specify a getCurrentValue function');\n    }\n    if (typeof subscribe !== 'function') {\n      console.error('Subscription must specify a subscribe function');\n    }\n  }\n\n  type Props = {|\n    children: (value: Value) => React$Element<any>,\n    source: Property,\n  |};\n  type State = {|\n    source: Property,\n    value: Value | void,\n  |};\n\n  // Reference: https://gist.github.com/bvaughn/d569177d70b50b58bff69c3c4a5353f3\n  class Subscription extends React.Component<Props, State> {\n    state: State = {\n      source: this.props.source,\n      value:\n        this.props.source != null\n          ? getCurrentValue(this.props.source)\n          : undefined,\n    };\n\n    _hasUnmounted: boolean = false;\n    _unsubscribe: Unsubscribe | null = null;\n\n    static getDerivedStateFromProps(nextProps, prevState) {\n      if (nextProps.source !== prevState.source) {\n        return {\n          source: nextProps.source,\n          value:\n            nextProps.source != null\n              ? getCurrentValue(nextProps.source)\n              : undefined,\n        };\n      }\n\n      return null;\n    }\n\n    componentDidMount() {\n      this.subscribe();\n    }\n\n    componentDidUpdate(prevProps, prevState) {\n      if (this.state.source !== prevState.source) {\n        this.unsubscribe();\n        this.subscribe();\n      }\n    }\n\n    componentWillUnmount() {\n      this.unsubscribe();\n\n      // Track mounted to avoid calling setState after unmounting\n      // For source like Promises that can't be unsubscribed from.\n      this._hasUnmounted = true;\n    }\n\n    render() {\n      return this.props.children(this.state.value);\n    }\n\n    subscribe() {\n      const {source} = this.state;\n      if (source != null) {\n        const callback = (value: Value | void) => {\n          if (this._hasUnmounted) {\n            return;\n          }\n\n          this.setState(state => {\n            // If the value is the same, skip the unnecessary state update.\n            if (value === state.value) {\n              return null;\n            }\n\n            // If this event belongs to an old or uncommitted data source, ignore it.\n            if (source !== state.source) {\n              return null;\n            }\n\n            return {value};\n          });\n        };\n\n        // Store the unsubscribe method for later (in case the subscribable prop changes).\n        const unsubscribe = subscribe(source, callback);\n        invariant(\n          typeof unsubscribe === 'function',\n          'A subscription must return an unsubscribe function.',\n        );\n\n        // It's safe to store unsubscribe on the instance because\n        // We only read or write that property during the \"commit\" phase.\n        this._unsubscribe = unsubscribe;\n\n        // External values could change between render and mount,\n        // In some cases it may be important to handle this case.\n        const value = getCurrentValue(this.props.source);\n        if (value !== this.state.value) {\n          this.setState({value});\n        }\n      }\n    }\n\n    unsubscribe() {\n      if (typeof this._unsubscribe === 'function') {\n        this._unsubscribe();\n      }\n      this._unsubscribe = null;\n    }\n  }\n\n  return Subscription;\n}\n"],"names":["ReactSharedInternals","React","error","format","args","printWarning","level","ReactDebugCurrentFrame","stack","getStackAddendum","concat","argsWithFormat","map","item","unshift","Function","prototype","apply","call","console","createSubscription","config","getCurrentValue","subscribe","Subscription","state","source","props","value","undefined","_hasUnmounted","_unsubscribe","getDerivedStateFromProps","nextProps","prevState","componentDidMount","componentDidUpdate","prevProps","unsubscribe","componentWillUnmount","render","children","callback","setState"],"mappings":"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"}
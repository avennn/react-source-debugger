{"version":3,"file":"react-suspense-test-utils.js","sources":["../../../../packages/shared/ReactSharedInternals.js","../../../../packages/react-suspense-test-utils/src/ReactSuspenseTestUtils.js"],"sourcesContent":["/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport * as React from 'react';\n\nconst ReactSharedInternals =\n  React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;\n\nexport default ReactSharedInternals;\n","/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Dispatcher} from 'react-reconciler/src/ReactInternalTypes';\nimport ReactSharedInternals from 'shared/ReactSharedInternals';\n\nconst ReactCurrentDispatcher = ReactSharedInternals.ReactCurrentDispatcher;\n\nfunction unsupported() {\n  throw new Error('This feature is not supported by ReactSuspenseTestUtils.');\n}\n\nexport function waitForSuspense<T>(fn: () => T): Promise<T> {\n  const cache: Map<Function, mixed> = new Map();\n  const testDispatcher: Dispatcher = {\n    getCacheForType<R>(resourceType: () => R): R {\n      let entry: R | void = (cache.get(resourceType): any);\n      if (entry === undefined) {\n        entry = resourceType();\n        // TODO: Warn if undefined?\n        cache.set(resourceType, entry);\n      }\n      return entry;\n    },\n    readContext: unsupported,\n    useContext: unsupported,\n    useMemo: unsupported,\n    useReducer: unsupported,\n    useRef: unsupported,\n    useState: unsupported,\n    useInsertionEffect: unsupported,\n    useLayoutEffect: unsupported,\n    useCallback: unsupported,\n    useImperativeHandle: unsupported,\n    useEffect: unsupported,\n    useDebugValue: unsupported,\n    useDeferredValue: unsupported,\n    useTransition: unsupported,\n    useId: unsupported,\n    useMutableSource: unsupported,\n    useSyncExternalStore: unsupported,\n    useCacheRefresh: unsupported,\n  };\n  // Not using async/await because we don't compile it.\n  return new Promise((resolve, reject) => {\n    function retry() {\n      const prevDispatcher = ReactCurrentDispatcher.current;\n      ReactCurrentDispatcher.current = testDispatcher;\n      try {\n        const result = fn();\n        resolve(result);\n      } catch (thrownValue) {\n        if (typeof thrownValue.then === 'function') {\n          thrownValue.then(retry, retry);\n        } else {\n          reject(thrownValue);\n        }\n      } finally {\n        ReactCurrentDispatcher.current = prevDispatcher;\n      }\n    }\n    retry();\n  });\n}\n"],"names":["ReactSharedInternals","React","ReactCurrentDispatcher","unsupported","Error","waitForSuspense","fn","cache","Map","testDispatcher","getCacheForType","resourceType","entry","get","undefined","set","readContext","useContext","useMemo","useReducer","useRef","useState","useInsertionEffect","useLayoutEffect","useCallback","useImperativeHandle","useEffect","useDebugValue","useDeferredValue","useTransition","useId","useMutableSource","useSyncExternalStore","useCacheRefresh","Promise","resolve","reject","retry","prevDispatcher","current","result","thrownValue","then"],"mappings":";;;;AAWA,IAAMA,oBAAoB,GACxBC,wDADF;;ACCA,IAAMC,sBAAsB,GAAGF,oBAAoB,CAACE,sBAApD;;AAEA,SAASC,WAAT,GAAuB;AACrB,QAAM,IAAIC,KAAJ,CAAU,0DAAV,CAAN;AACD;;AAED,AAAO,SAASC,eAAT,CAA4BC,EAA5B,EAAqD;AAC1D,MAAMC,KAA2B,GAAG,IAAIC,GAAJ,EAApC;AACA,MAAMC,cAA0B,GAAG;AACjCC,IAAAA,eADiC,YACdC,YADc,EACY;AAC3C,UAAIC,KAAe,GAAIL,KAAK,CAACM,GAAN,CAAUF,YAAV,CAAvB;;AACA,UAAIC,KAAK,KAAKE,SAAd,EAAyB;AACvBF,QAAAA,KAAK,GAAGD,YAAY,EAApB,CADuB;;AAGvBJ,QAAAA,KAAK,CAACQ,GAAN,CAAUJ,YAAV,EAAwBC,KAAxB;AACD;;AACD,aAAOA,KAAP;AACD,KATgC;AAUjCI,IAAAA,WAAW,EAAEb,WAVoB;AAWjCc,IAAAA,UAAU,EAAEd,WAXqB;AAYjCe,IAAAA,OAAO,EAAEf,WAZwB;AAajCgB,IAAAA,UAAU,EAAEhB,WAbqB;AAcjCiB,IAAAA,MAAM,EAAEjB,WAdyB;AAejCkB,IAAAA,QAAQ,EAAElB,WAfuB;AAgBjCmB,IAAAA,kBAAkB,EAAEnB,WAhBa;AAiBjCoB,IAAAA,eAAe,EAAEpB,WAjBgB;AAkBjCqB,IAAAA,WAAW,EAAErB,WAlBoB;AAmBjCsB,IAAAA,mBAAmB,EAAEtB,WAnBY;AAoBjCuB,IAAAA,SAAS,EAAEvB,WApBsB;AAqBjCwB,IAAAA,aAAa,EAAExB,WArBkB;AAsBjCyB,IAAAA,gBAAgB,EAAEzB,WAtBe;AAuBjC0B,IAAAA,aAAa,EAAE1B,WAvBkB;AAwBjC2B,IAAAA,KAAK,EAAE3B,WAxB0B;AAyBjC4B,IAAAA,gBAAgB,EAAE5B,WAzBe;AA0BjC6B,IAAAA,oBAAoB,EAAE7B,WA1BW;AA2BjC8B,IAAAA,eAAe,EAAE9B;AA3BgB,GAAnC,CAF0D;;AAgC1D,SAAO,IAAI+B,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,aAASC,KAAT,GAAiB;AACf,UAAMC,cAAc,GAAGpC,sBAAsB,CAACqC,OAA9C;AACArC,MAAAA,sBAAsB,CAACqC,OAAvB,GAAiC9B,cAAjC;;AACA,UAAI;AACF,YAAM+B,MAAM,GAAGlC,EAAE,EAAjB;AACA6B,QAAAA,OAAO,CAACK,MAAD,CAAP;AACD,OAHD,CAGE,OAAOC,WAAP,EAAoB;AACpB,YAAI,OAAOA,WAAW,CAACC,IAAnB,KAA4B,UAAhC,EAA4C;AAC1CD,UAAAA,WAAW,CAACC,IAAZ,CAAiBL,KAAjB,EAAwBA,KAAxB;AACD,SAFD,MAEO;AACLD,UAAAA,MAAM,CAACK,WAAD,CAAN;AACD;AACF,OATD,SASU;AACRvC,QAAAA,sBAAsB,CAACqC,OAAvB,GAAiCD,cAAjC;AACD;AACF;;AACDD,IAAAA,KAAK;AACN,GAlBM,CAAP;AAmBD;;;;"}
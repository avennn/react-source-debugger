{"version":3,"file":"react-server-dom-webpack-node-register.js","sources":["../../../../packages/react-server-dom-webpack/src/ReactFlightWebpackNodeRegister.js"],"sourcesContent":["/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nconst url = require('url');\n\n// $FlowFixMe\nconst Module = require('module');\n\nmodule.exports = function register() {\n  const MODULE_REFERENCE = Symbol.for('react.module.reference');\n  const proxyHandlers = {\n    get: function(target, name, receiver) {\n      switch (name) {\n        // These names are read by the Flight runtime if you end up using the exports object.\n        case '$$typeof':\n          // These names are a little too common. We should probably have a way to\n          // have the Flight runtime extract the inner target instead.\n          return target.$$typeof;\n        case 'filepath':\n          return target.filepath;\n        case 'name':\n          return target.name;\n        // We need to special case this because createElement reads it if we pass this\n        // reference.\n        case 'defaultProps':\n          return undefined;\n        case '__esModule':\n          // Something is conditionally checking which export to use. We'll pretend to be\n          // an ESM compat module but then we'll check again on the client.\n          target.default = {\n            $$typeof: MODULE_REFERENCE,\n            filepath: target.filepath,\n            // This a placeholder value that tells the client to conditionally use the\n            // whole object or just the default export.\n            name: '',\n          };\n          return true;\n      }\n      let cachedReference = target[name];\n      if (!cachedReference) {\n        cachedReference = target[name] = {\n          $$typeof: MODULE_REFERENCE,\n          filepath: target.filepath,\n          name: name,\n        };\n      }\n      return cachedReference;\n    },\n    set: function() {\n      throw new Error('Cannot assign to a client module from a server module.');\n    },\n  };\n\n  (require: any).extensions['.client.js'] = function(module, path) {\n    const moduleId = url.pathToFileURL(path).href;\n    const moduleReference: {[string]: any} = {\n      $$typeof: MODULE_REFERENCE,\n      filepath: moduleId,\n      name: '*', // Represents the whole object instead of a particular import.\n    };\n    module.exports = new Proxy(moduleReference, proxyHandlers);\n  };\n\n  const originalResolveFilename = Module._resolveFilename;\n\n  Module._resolveFilename = function(request, parent, isMain, options) {\n    const resolved = originalResolveFilename.apply(this, arguments);\n    if (resolved.endsWith('.server.js')) {\n      if (\n        parent &&\n        parent.filename &&\n        !parent.filename.endsWith('.server.js')\n      ) {\n        let reason;\n        if (request.endsWith('.server.js')) {\n          reason = `\"${request}\"`;\n        } else {\n          reason = `\"${request}\" (which expands to \"${resolved}\")`;\n        }\n        throw new Error(\n          `Cannot import ${reason} from \"${parent.filename}\". ` +\n            'By react-server convention, .server.js files can only be imported from other .server.js files. ' +\n            'That way nobody accidentally sends these to the client by indirectly importing it.',\n        );\n      }\n    }\n    return resolved;\n  };\n};\n"],"names":["url","require","Module","module","exports","register","MODULE_REFERENCE","Symbol","for","proxyHandlers","get","target","name","receiver","$$typeof","filepath","undefined","default","cachedReference","set","Error","extensions","path","moduleId","pathToFileURL","href","moduleReference","Proxy","originalResolveFilename","_resolveFilename","request","parent","isMain","options","resolved","apply","arguments","endsWith","filename","reason"],"mappings":"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"}
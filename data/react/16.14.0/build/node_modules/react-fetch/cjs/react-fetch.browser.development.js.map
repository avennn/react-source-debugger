{"version":3,"file":"react-fetch.browser.development.js","sources":["../../../../packages/react-fetch/src/ReactFetchBrowser.js"],"sourcesContent":["/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @flow\n */\n\nimport type {Wakeable} from 'shared/ReactTypes';\n\nimport {readCache} from 'react/unstable-cache';\n\nconst Pending = 0;\nconst Resolved = 1;\nconst Rejected = 2;\n\ntype PendingResult = {|\n  status: 0,\n  value: Wakeable,\n|};\n\ntype ResolvedResult = {|\n  status: 1,\n  value: mixed,\n|};\n\ntype RejectedResult = {|\n  status: 2,\n  value: mixed,\n|};\n\ntype Result = PendingResult | ResolvedResult | RejectedResult;\n\n// TODO: this is a browser-only version. Add a separate Node entry point.\nconst nativeFetch = window.fetch;\nconst fetchKey = {};\n\nfunction readResultMap(): Map<string, Result> {\n  const resources = readCache().resources;\n  let map = resources.get(fetchKey);\n  if (map === undefined) {\n    map = new Map();\n    resources.set(fetchKey, map);\n  }\n  return map;\n}\n\nfunction toResult(thenable): Result {\n  const result: Result = {\n    status: Pending,\n    value: thenable,\n  };\n  thenable.then(\n    value => {\n      if (result.status === Pending) {\n        const resolvedResult = ((result: any): ResolvedResult);\n        resolvedResult.status = Resolved;\n        resolvedResult.value = value;\n      }\n    },\n    err => {\n      if (result.status === Pending) {\n        const rejectedResult = ((result: any): RejectedResult);\n        rejectedResult.status = Rejected;\n        rejectedResult.value = err;\n      }\n    },\n  );\n  return result;\n}\n\nfunction readResult(result: Result) {\n  if (result.status === Resolved) {\n    return result.value;\n  } else {\n    throw result.value;\n  }\n}\n\nfunction Response(nativeResponse) {\n  this.headers = nativeResponse.headers;\n  this.ok = nativeResponse.ok;\n  this.redirected = nativeResponse.redirected;\n  this.status = nativeResponse.status;\n  this.statusText = nativeResponse.statusText;\n  this.type = nativeResponse.type;\n  this.url = nativeResponse.url;\n\n  this._response = nativeResponse;\n  this._arrayBuffer = null;\n  this._blob = null;\n  this._json = null;\n  this._text = null;\n}\n\nResponse.prototype = {\n  constructor: Response,\n  arrayBuffer() {\n    return readResult(\n      this._arrayBuffer ||\n        (this._arrayBuffer = toResult(this._response.arrayBuffer())),\n    );\n  },\n  blob() {\n    return readResult(\n      this._blob || (this._blob = toResult(this._response.blob())),\n    );\n  },\n  json() {\n    return readResult(\n      this._json || (this._json = toResult(this._response.json())),\n    );\n  },\n  text() {\n    return readResult(\n      this._text || (this._text = toResult(this._response.text())),\n    );\n  },\n};\n\nfunction preloadResult(url: string, options: mixed): Result {\n  const map = readResultMap();\n  let entry = map.get(url);\n  if (!entry) {\n    if (options) {\n      if (options.method || options.body || options.signal) {\n        // TODO: wire up our own cancellation mechanism.\n        // TODO: figure out what to do with POST.\n        throw Error('Unsupported option');\n      }\n    }\n    const thenable = nativeFetch(url, options);\n    entry = toResult(thenable);\n    map.set(url, entry);\n  }\n  return entry;\n}\n\nexport function preload(url: string, options: mixed): void {\n  preloadResult(url, options);\n  // Don't return anything.\n}\n\nexport function fetch(url: string, options: mixed): Object {\n  const result = preloadResult(url, options);\n  const nativeResponse = (readResult(result): any);\n  if (nativeResponse._reactResponse) {\n    return nativeResponse._reactResponse;\n  } else {\n    return (nativeResponse._reactResponse = new Response(nativeResponse));\n  }\n}\n"],"names":["Pending","Resolved","Rejected","nativeFetch","window","fetch","fetchKey","readResultMap","resources","readCache","map","get","undefined","Map","set","toResult","thenable","result","status","value","then","resolvedResult","err","rejectedResult","readResult","Response","nativeResponse","headers","ok","redirected","statusText","type","url","_response","_arrayBuffer","_blob","_json","_text","prototype","constructor","arrayBuffer","blob","json","text","preloadResult","options","entry","method","body","signal","Error","preload","_reactResponse"],"mappings":";;;;AAaA,IAAMA,OAAO,GAAG,CAAhB;AACA,IAAMC,QAAQ,GAAG,CAAjB;AACA,IAAMC,QAAQ,GAAG,CAAjB;AAmBA;AACA,IAAMC,WAAW,GAAGC,MAAM,CAACC,KAA3B;AACA,IAAMC,QAAQ,GAAG,EAAjB;;AAEA,SAASC,aAAT,GAA8C;AAC5C,MAAMC,SAAS,GAAGC,uBAAS,GAAGD,SAA9B;AACA,MAAIE,GAAG,GAAGF,SAAS,CAACG,GAAV,CAAcL,QAAd,CAAV;;AACA,MAAII,GAAG,KAAKE,SAAZ,EAAuB;AACrBF,IAAAA,GAAG,GAAG,IAAIG,GAAJ,EAAN;AACAL,IAAAA,SAAS,CAACM,GAAV,CAAcR,QAAd,EAAwBI,GAAxB;AACD;;AACD,SAAOA,GAAP;AACD;;AAED,SAASK,QAAT,CAAkBC,QAAlB,EAAoC;AAClC,MAAMC,MAAc,GAAG;AACrBC,IAAAA,MAAM,EAAElB,OADa;AAErBmB,IAAAA,KAAK,EAAEH;AAFc,GAAvB;AAIAA,EAAAA,QAAQ,CAACI,IAAT,CACE,UAAAD,KAAK,EAAI;AACP,QAAIF,MAAM,CAACC,MAAP,KAAkBlB,OAAtB,EAA+B;AAC7B,UAAMqB,cAAc,GAAKJ,MAAzB;AACAI,MAAAA,cAAc,CAACH,MAAf,GAAwBjB,QAAxB;AACAoB,MAAAA,cAAc,CAACF,KAAf,GAAuBA,KAAvB;AACD;AACF,GAPH,EAQE,UAAAG,GAAG,EAAI;AACL,QAAIL,MAAM,CAACC,MAAP,KAAkBlB,OAAtB,EAA+B;AAC7B,UAAMuB,cAAc,GAAKN,MAAzB;AACAM,MAAAA,cAAc,CAACL,MAAf,GAAwBhB,QAAxB;AACAqB,MAAAA,cAAc,CAACJ,KAAf,GAAuBG,GAAvB;AACD;AACF,GAdH;AAgBA,SAAOL,MAAP;AACD;;AAED,SAASO,UAAT,CAAoBP,MAApB,EAAoC;AAClC,MAAIA,MAAM,CAACC,MAAP,KAAkBjB,QAAtB,EAAgC;AAC9B,WAAOgB,MAAM,CAACE,KAAd;AACD,GAFD,MAEO;AACL,UAAMF,MAAM,CAACE,KAAb;AACD;AACF;;AAED,SAASM,QAAT,CAAkBC,cAAlB,EAAkC;AAChC,OAAKC,OAAL,GAAeD,cAAc,CAACC,OAA9B;AACA,OAAKC,EAAL,GAAUF,cAAc,CAACE,EAAzB;AACA,OAAKC,UAAL,GAAkBH,cAAc,CAACG,UAAjC;AACA,OAAKX,MAAL,GAAcQ,cAAc,CAACR,MAA7B;AACA,OAAKY,UAAL,GAAkBJ,cAAc,CAACI,UAAjC;AACA,OAAKC,IAAL,GAAYL,cAAc,CAACK,IAA3B;AACA,OAAKC,GAAL,GAAWN,cAAc,CAACM,GAA1B;AAEA,OAAKC,SAAL,GAAiBP,cAAjB;AACA,OAAKQ,YAAL,GAAoB,IAApB;AACA,OAAKC,KAAL,GAAa,IAAb;AACA,OAAKC,KAAL,GAAa,IAAb;AACA,OAAKC,KAAL,GAAa,IAAb;AACD;;AAEDZ,QAAQ,CAACa,SAAT,GAAqB;AACnBC,EAAAA,WAAW,EAAEd,QADM;AAEnBe,EAAAA,WAFmB,cAEL;AACZ,WAAOhB,UAAU,CACf,KAAKU,YAAL,KACG,KAAKA,YAAL,GAAoBnB,QAAQ,CAAC,KAAKkB,SAAL,CAAeO,WAAf,EAAD,CAD/B,CADe,CAAjB;AAID,GAPkB;AAQnBC,EAAAA,IARmB,cAQZ;AACL,WAAOjB,UAAU,CACf,KAAKW,KAAL,KAAe,KAAKA,KAAL,GAAapB,QAAQ,CAAC,KAAKkB,SAAL,CAAeQ,IAAf,EAAD,CAApC,CADe,CAAjB;AAGD,GAZkB;AAanBC,EAAAA,IAbmB,cAaZ;AACL,WAAOlB,UAAU,CACf,KAAKY,KAAL,KAAe,KAAKA,KAAL,GAAarB,QAAQ,CAAC,KAAKkB,SAAL,CAAeS,IAAf,EAAD,CAApC,CADe,CAAjB;AAGD,GAjBkB;AAkBnBC,EAAAA,IAlBmB,cAkBZ;AACL,WAAOnB,UAAU,CACf,KAAKa,KAAL,KAAe,KAAKA,KAAL,GAAatB,QAAQ,CAAC,KAAKkB,SAAL,CAAeU,IAAf,EAAD,CAApC,CADe,CAAjB;AAGD;AAtBkB,CAArB;;AAyBA,SAASC,aAAT,CAAuBZ,GAAvB,EAAoCa,OAApC,EAA4D;AAC1D,MAAMnC,GAAG,GAAGH,aAAa,EAAzB;AACA,MAAIuC,KAAK,GAAGpC,GAAG,CAACC,GAAJ,CAAQqB,GAAR,CAAZ;;AACA,MAAI,CAACc,KAAL,EAAY;AACV,QAAID,OAAJ,EAAa;AACX,UAAIA,OAAO,CAACE,MAAR,IAAkBF,OAAO,CAACG,IAA1B,IAAkCH,OAAO,CAACI,MAA9C,EAAsD;AACpD;AACA;AACA,cAAMC,KAAK,CAAC,oBAAD,CAAX;AACD;AACF;;AACD,QAAMlC,QAAQ,GAAGb,WAAW,CAAC6B,GAAD,EAAMa,OAAN,CAA5B;AACAC,IAAAA,KAAK,GAAG/B,QAAQ,CAACC,QAAD,CAAhB;AACAN,IAAAA,GAAG,CAACI,GAAJ,CAAQkB,GAAR,EAAac,KAAb;AACD;;AACD,SAAOA,KAAP;AACD;;AAEM,SAASK,OAAT,CAAiBnB,GAAjB,EAA8Ba,OAA9B,EAAoD;AACzDD,EAAAA,aAAa,CAACZ,GAAD,EAAMa,OAAN,CAAb,CADyD;AAG1D;AAEM,SAASxC,KAAT,CAAe2B,GAAf,EAA4Ba,OAA5B,EAAoD;AACzD,MAAM5B,MAAM,GAAG2B,aAAa,CAACZ,GAAD,EAAMa,OAAN,CAA5B;AACA,MAAMnB,cAAc,GAAIF,UAAU,CAACP,MAAD,CAAlC;;AACA,MAAIS,cAAc,CAAC0B,cAAnB,EAAmC;AACjC,WAAO1B,cAAc,CAAC0B,cAAtB;AACD,GAFD,MAEO;AACL,WAAQ1B,cAAc,CAAC0B,cAAf,GAAgC,IAAI3B,QAAJ,CAAaC,cAAb,CAAxC;AACD;AACF;;;;;"}